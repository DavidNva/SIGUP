
@{
    ViewBag.Title = "HistorialPrestamos";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h1 class="mt-4"><i class="fas fa-clock text-success"></i> Historial de Préstamos</h1>
<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item active">Selecciona opciones de búsqueda para ver el Historial de Préstamos</li>
</ol>
<form action="@Url.Action("DescargarPDF_HistorialPrestamos","SIGUP")" class="mt-0 ml-2">
    <div class="row align-items-end" id="contenedor">
        <div class="col-sm-3 col-md-2">
            <div class="mb-2">
                <label class="form-label" for="txtFechaInicio">Fecha de Inicio:</label>
                <input class="form-control" type="text" id="txtFechaInicio" name="fechaInicio" />
            </div>
        </div>
        <div class="col-sm-3 col-md-2">
            <div class="mb-2">
                <label class="form-label" for="txtFechaFin" >Fecha Fin:</label>
                <input class="form-control" type="text" id="txtFechaFin" name="fechafin" />
            </div>
        </div>
        <div class="col-sm-2">
            <div class="mb-2">
                <label class="form-label" for="txtCodigo" >Número de Control:</label>
                <input class="form-control" type="text" id="txtCodigo" name="codigoUsuario" autocomplete="off" placeholder="# Control o Nomina" />
            </div>
        </div>
        @*<div class="col-sm-2">
                <div class="mb-2">
                    <label class="form-label" for="txtCodigo">Estado:</label>
                    <input class="form-control" type="text" id="txtEstado" name="estado" autocomplete="off" />
                </div>
            </div>*@
        <div class="col-sm-2">
            <div class="mb-2">
                <label for="txtEstado" class="form-label"> Estado </label>
                <select id="txtEstado" class="form-select" name="estado">
                    <option value="">Seleccionar (Todos) </option>
                    <option value="1">Pendientes</option>
                    <option value="0">Devueltos</option>
                </select>
            </div>
        </div>

        <div class="col-sm-2">
            <div class="mb-2">
                <label for="txtHerramienta" class="form-label"> Herramienta </label>
                <select id="txtHerramienta" class="form-select" name="herramienta"> 
                    <option value="">Seleccionar Herramienta</option>
                    @*<option value="CASCO">CASCO</option>
                        <option value="TELEVISION2">TELEVISION2</option>*@

                </select>
            </div>
        </div>
        @*<div class="col-sm-2">
                <div class="mb-2">
                    <label class="form-label" for="txtHerramienta">Herramienta:</label>
                    <input class="form-control" type="text" id="txtHerramienta" name="herramienta" autocomplete="off" />
                </div>
            </div>*@

        <div class="col-sm-2">
            <div class="d-grid mb-2">
                <button class="btn btn-primary " id="btnBuscar" type="button"><i class="fas fa-search"></i> Buscar</button>
            </div>
        </div>
        <div class="col-sm-2">
            <div class="d-grid mb-2">
                <button class="btn btn-danger" type="submit"><i class="fas fa-file-pdf"></i>Descargar PDF</button>
            </div>
        </div>
    </div>
</form>
@*<form action="@Url.Action("DescargarPDF_Categoria","SIGUP")" class="mt-0 ml-2">
    <button class="btn btn-danger" type="submit"><i class="fas fa-file-pdf"></i> Descargar PDF</button>
</form>*@
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-tags me-1"></i> @*Titulo de la tabla*@
        Historial de Préstamos
    </div>

    <div class="card-body">
        <form action="@Url.Action("ExportarPrestamo","SIGUP")" method="post">
            <!--<div class="row align-items-end">
                <div class="col-sm-3 col-md-2">
                    <div class="mb-2">
                        <label class="form-label" for="txtFechaInicio">Fecha de Inicio:</label>
                        <input class="form-control" type="text" id="txtFechaInicio" name="fechainicio" />
                    </div>
                </div>
                <div class="col-sm-3 col-md-2">
                    <div class="mb-2">
                        <label class="form-label" for="txtFechaFin">Fecha Fin:</label>
                        <input class="form-control" type="text" id="txtFechaFin" name="fechafin" />
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="mb-2">
                        <label class="form-label" for="txtCodigo">Código Herramienta:</label>
                        <input class="form-control" type="text" id="txtCodigo" name="codigo" autocomplete="off" />
                    </div>
                </div>-->
            @*<div class="col-sm-2">
                    <div class="mb-2">
                        <label class="form-label" for="txtCodigo">Estado:</label>
                        <input class="form-control" type="text" id="txtEstado" name="estado" autocomplete="off" />
                    </div>
                </div>*@
            <!--<div class="col-sm-2">
                    <div class="mb-2">
                        <label for="txtEstado" class="form-label"> Estado </label>
                        <select id="txtEstado" class="form-select">
                            <option value="1">Pendientes</option>
                            <option value="0">Devueltos</option>
                        </select>
                    </div>
                </div>


                <div class="col-sm-2">
                    <div class="d-grid mb-2">
                        <button class="btn btn-primary " id="btnBuscar" type="button"><i class="fas fa-search"></i> Buscar</button>
                    </div>
                </div>
                <div class="col-sm-2">
                    <div class="d-grid mb-2">
                        <button class="btn btn-success" type="submit"><i class="fas fa-file-excel"></i> Exportar</button>
                    </div>
                </div>
            </div>-->
        </form>
        @*<hr />*@
        <div class="row">
            <div class="col-sm-12">
                <table id="tabla" class="display cell-border" style="width:100%">
                    <thead>
                        <tr>
                            <th>Fecha del Préstamo</th>

                            <th>Usuario</th>
                            <th>IDUsuario</th>
                            <th>Herramienta</th>
                            <th>Detalles</th>
                            <th>Dias Solicitados</th>
                            <th>Fecha de Devolución</th>
                            <th>Estado del Préstamo</th>
                            @*<th>Total</th>*@
                            <th>Observaciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>.
        </div>

    </div>
</div>


@section scripts{
    <script>
            window.onload = function () {

                if (window.innerWidth <= 767) {
                    // Si el ancho de la pantalla es igual o menor a 767px (tamaño de teléfono), quitar la clase 'sb-sidenav-toggled'
                    document.getElementById('body-layout').classList.remove('sb-sidenav-toggled');
                } else {
                    // Si el ancho de la pantalla es mayor a 767px, agregar la clase 'sb-sidenav-toggled'
                    document.getElementById('body-layout').classList.add('sb-sidenav-toggled');
                }
            };

            var tabladata;

            $(document).ready(function () {/* asi como entra a la pagina de dashboard se automatiza la tabla con las fechas de hoy ya que son las que estan en los input*/

                $("#txtFechaInicio").datepicker({ dateFormat: 'dd/mm/yy' }).datepicker('setDate', new Date())
                $("#txtFechaFin").datepicker({ dateFormat: 'dd/mm/yy' }).datepicker('setDate', new Date())


                /*Para mostrar totales en las tarjetas del dashboard*/
                jQuery.ajax({
                    url: '@Url.Action("VistaDashBoard", "SIGUP")',
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json; charset=utf-8",
                    success: function (data) {/*Ese data esta almacenando la respuesta del metodo vistadashboard hecho en homeController*/
                        var objeto = data.resultado;

                        $("#totalUsuario").text(objeto.TotalUsuario),
                        $("#totalPrestamo").text(objeto.TotalPrestamo),
                        $("#totalHerramienta").text(objeto.TotalHerramienta),
                            $("#totalEjemplaresHerramienta").text(objeto.TotalEjemplaresHerramienta)

                    }
                });

                /* Para dar uso al metodo de buscar y lo muestre en una tabla resultante*/

                var Url = '@Url.Action("ListaReporte", "SIGUP")' +
                    "?fechaInicio=" + $("#txtFechaInicio").val() +
                    "&fechaFin=" + $("#txtFechaFin").val() +
                    "&codigoUsuario=" + $("#txtCodigo").val() +
                    "&estado=" + $("#txtEstado").val() +
                    "&herramienta=" + $("#txtHerramienta").val()


                tabladata = $("#tabla").DataTable({
                    responsive: true,
                    /*Para que sea resposiva*/
                    ordering: false,
                    "ajax": {
                        /*Como pinta la tabla, ajax solo trae todos los valores*/
                        url: Url,
                        type: "GET",
                        dataType: "json"
                    },
                    "columns": [
                        /*Todas las columnas que vamos a usar*/
                        //{
                        //    "data": "IdUsuario", "render": function (data) {/*El render permite obtener el valor de la columna*/
                        //        return data.IdUsuario
                        //    },
                        //    "visible": false
                        //},
                     /*   console.log(data),*/

                            { "data": "FechaPrestamo", "width": "90px" },
                            
                            { "data": "Usuario" },
                       /* { "data": "IdUsuario" },*/
                        { "data": "IdUsuario", "visible": false },
                            //{
                            //    "data": "IdUsuario", "render": function (data) {/*El render permite obtener el valor de la columna*/
                        //        return data.IdUsuario
                            //   },
                            //    "visible": false
                            //},
                            { "data": "Herramienta" },
                            /*El nombre del segundo identificador debe ser igual al de la tabla, la columna*/
                        { "data": "Detalles" },
                        { "data": "DiasSolicitados", "width": "70px" },
                        { "data": "FechaDevolucion", "width": "90px" },
                            {
                                "data": "Estado", "render": function (valor) {
                                /*El render permite obtener el valor de la columna activo*/
                                    //if (valor) {/*Si el valor es verdadero*/
                                    //    return '<span class="badge bg-success">Si</span>'
                                    //} else {
                                    //    return '<span class="badge bg-danger">No</span>'
                                    //}
                                    if (valor) {/*Si el valor es verdadero*/
                                        return '<span class="badge bg-danger">Pendiente</span>'
                                        //Si Significa que esta pendiente = 1 = Activo
                                    } else {
                                        return '<span class="badge bg-success">Devuelto</span>'
                                        //No, Significa que el prestamo devuelto = 0 = Inactivo
                                    }
                                },
                                "width": "90px"
                            },
                            { "data": "Observaciones" }

                       ],
                        /*Propiedad o atributos van dentro de las comillas ""*/
                        "language": {
                            "url": "https://cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
                        }

                });

            })

           $("#btnBuscar").on("click", function (){
                var nueva_url = '@Url.Action("ListaReporte", "SIGUP")' +
                    "?fechaInicio=" + $("#txtFechaInicio").val() +
                    "&fechaFin=" + $("#txtFechaFin").val() +
                    "&codigoUsuario=" + $("#txtCodigo").val() +
                    "&estado=" + $("#txtEstado").val() +
                    "&herramienta=" + $("#txtHerramienta").val()

                //console.log(nueva_url);
                tabladata.ajax.url(nueva_url).load();
            })


             jQuery.ajax({
                 url: '@Url.Action("ListarHerramientaParaHistorialPrestamo", "SIGUP")',
                 type: "GET",
                 data: null,
                 dataType: "json",
                 contentType: "application/json; charset=utf-8",
                 success: function (data) {
                     $("#txtHerramienta").append($("<option selected>").val("").attr({ "value": ""}).text("Seleccionar Herramienta"));

                     $.each(data.data, function (index, item) {
                         $("<option>").attr({ "value": item.nombre }).text(item.nombre).appendTo("#txtHerramienta");
                     })
                     $("#txtHerramienta").select2({ placeholder: "Seleccionar", width: "100%", dropdownParent: $('#contenedor') });

                     //podemos dejar la siguiente opcion para darle un estilo similar al combobox, aun funcionaria la libreria solo escribiendo el nombre
                     //de la herramienta, aparecerá, pero ya sin ver la opcion de un cuadro de text, de ser este el caso, se debe quitar el seleccionar creado
                     //en esta funcion que esta 7 lineas arriba
                     /*$("#txtHerramienta").select2({ placeholder: "Seleccionar", width: "100%", dropdownParent: $('#contenedor').addClass("form-select") });*/
                 },
                 error: function (error) {
                     console.log(error)
                  }
             });//Lista de herramientas para prestamo

    </script>
}


